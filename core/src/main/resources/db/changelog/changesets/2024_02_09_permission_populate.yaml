databaseChangeLog:
  - changeSet:
      id: "add_initial_permissions"
      author: dbush
      changes:
        - addColumn:
            tableName: portal_admin_user_role
            columns:
              - column: { name: study_id, type: uuid, constraints:
                { foreignKeyName: fk_portal_admin_user_role_study, references: study(id) }
              }
        - sql:
            sql: insert into permission 
              (name, display_name, description, created_at, last_updated_at)
              values
              ('study_settings', 'Study settings', 'Configure study settings password protection and enrollment', now(), now()),
              ('site_content_edit', 'Site content edit', 'Make changes to the portal website', now(), now());
        - sql:
            sql: insert into role
              (name, display_name, description, created_at, last_updated_at)
              values
              ('study_admin', 'Study admin', 'View and edit all aspects of a study', now(), now());
        - sql:
            sql: insert into role_permission
              (role_id, permission_id, created_at, last_updated_at)
              select role.id, permission.id, now(), now() from role cross join permission where role.name = 'study_admin';
        - sql:
            sql: insert into portal_admin_user_role 
              (portal_admin_user_id, role_id, study_id, created_at, last_updated_at)
              select portal_admin_user.id, role.id, null, now(), now() from portal_admin_user 
              join admin_user on portal_admin_user.admin_user_id = admin_user.id
              cross join role
              where admin_user.superuser = false;
